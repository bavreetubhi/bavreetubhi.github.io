<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>COPV Layup Optimiser — Block Diagram</title>

    <style>
      :root {
        /* ---- Palette ---- */
        --blue: #bfe1ff;
        --green: #bfe8a8;
        --orange: #ffe1bf;
        --mint: #dff2e7;

        --line: #262626;
        --text: #161616;

        --radius: 12px;
        --shadow: 0 10px 28px rgba(0, 0, 0, 0.08);
        --border: 1px solid rgba(0, 0, 0, 0.10);

        --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }

      body {
        margin: 0;
        background: #fff;
        font-family: var(--font);
        color: var(--text);
      }

      /* Canvas */
      .diagram {
        position: relative;
        width: min(1600px, 96vw);
        height: 780px;
        margin: 22px auto;
        background: #fff;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 16px;
        overflow: hidden;
      }

      .title {
        position: absolute;
        left: 18px;
        top: 14px;
        font-size: 14px;
        opacity: 0.6;
      }

      /* SVG wires */
      svg#wires {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      /* Blocks */
      .box {
        position: absolute;
        display: grid;
        place-items: center;
        text-align: center;
        border-radius: var(--radius);
        border: var(--border);
        box-shadow: var(--shadow);
        font-weight: 750;
        font-size: 15px;
        line-height: 1.2;
        padding: 12px 14px;
        user-select: none;
      }

      .sub {
        margin-top: 8px;
        font-size: 12px;
        font-weight: 850;
        opacity: 0.65;
        line-height: 1.25;
      }

      .blue { background: var(--blue); }
      .green { background: var(--green); }
      .orange { background: var(--orange); }
      .mint { background: var(--mint); }

      .wire-label {
        font-size: 12px;
        font-weight: 850;
        fill: var(--line);
        opacity: 0.9;
      }
    </style>
  </head>

  <body>
    <div class="diagram" id="diagram">
      <div class="title">COPV Layup Optimiser — Block Diagram</div>

      <!-- =========================================================
           SPACED LAYOUT (not crowded)
           Columns: Inputs | Files | Core | Outputs | View
           ========================================================= -->

      <!-- Column 1: Inputs -->
      <div class="box blue" id="user" style="left:80px; top:110px; width:300px; height:96px;">
        User / GUI / Run.py
      </div>

      <div class="box blue" id="matjson" style="left:80px; top:250px; width:300px; height:96px;">
        Material DB JSON
      </div>

      <div class="box blue" id="optional" style="left:80px; top:430px; width:300px; height:130px;">
        Optional Sweep<br/>Parameters
      </div>

      <!-- Column 2: Files -->
      <div class="box green" id="config" style="left:450px; top:110px; width:260px; height:96px;">
        config.cfg
      </div>

      <div class="box green" id="matdb" style="left:450px; top:250px; width:260px; height:96px;">
        MaterialDB
      </div>

      <!-- Column 3: Core -->
      <div class="box green" id="cli" style="left:820px; top:140px; width:430px; height:210px;">
        copv_cli.exe
        <div class="sub">(initialise + parse)</div>
      </div>

      <div class="box green" id="loop" style="left:820px; top:390px; width:430px; height:340px;">
        Optimisation Loop
        <div class="sub">
          Candidate → Stackup → ABD<br/>
          Loading → Failure → FoS/Mass<br/>
          CSV Log
        </div>
      </div>

      <!-- Column 4: Outputs (spaced + wider) -->
      <div class="box orange" id="plot" style="left:1320px; top:240px; width:300px; height:140px;">
        Post-Processing<br/>& Plotting
      </div>

      <div class="box orange" id="outtxt" style="left:1320px; top:440px; width:300px; height:95px;">
        optimisation_output.txt
      </div>

      <div class="box orange" id="outcsv" style="left:1320px; top:580px; width:300px; height:95px;">
        mass_vs_fos.csv
      </div>

      <!-- Column 5: View (final stage, spaced) -->
      <div class="box mint" id="view" style="left:1585px; top:240px; width:280px; height:140px; transform: translateX(-280px);">
        User Views<br/>Results
      </div>

      <!-- Wires -->
      <svg id="wires" preserveAspectRatio="none">
        <defs>
          <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--line)"></path>
          </marker>
        </defs>
      </svg>
    </div>

    <script>
      const diagram = document.getElementById("diagram");
      const svg = document.getElementById("wires");

      function rect(id) {
        const d = diagram.getBoundingClientRect();
        const r = document.getElementById(id).getBoundingClientRect();
        const left = r.left - d.left;
        const top = r.top - d.top;
        return {
          left,
          top,
          right: left + r.width,
          bottom: top + r.height,
          cx: left + r.width / 2,
          cy: top + r.height / 2,
          w: r.width,
          h: r.height
        };
      }

      function port(R, side, offset = 0) {
        if (side === "right")  return { x: R.right, y: R.cy + offset };
        if (side === "left")   return { x: R.left,  y: R.cy + offset };
        if (side === "top")    return { x: R.cx + offset, y: R.top };
        if (side === "bottom") return { x: R.cx + offset, y: R.bottom };
        return { x: R.cx, y: R.cy };
      }

      function clearWiresKeepDefs() {
        const defs = svg.querySelector("defs");
        svg.innerHTML = "";
        svg.appendChild(defs);
      }

      // Polyline wire (orth routing), optional arrow/label.
      function addWire(points, { arrowEnd = false, label = null, labelAt = 0.55, dashed = false } = {}) {
        const d = points.map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`).join(" ");

        const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
        p.setAttribute("d", d);
        p.setAttribute("fill", "none");
        p.setAttribute("stroke", "var(--line)");
        p.setAttribute("stroke-width", "2.2");
        p.setAttribute("stroke-linejoin", "round");
        p.setAttribute("stroke-linecap", "round");
        if (dashed) p.setAttribute("stroke-dasharray", "7 7");
        if (arrowEnd) p.setAttribute("marker-end", "url(#arrow)");
        svg.appendChild(p);

        if (label) {
          const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
          t.setAttribute("class", "wire-label");
          const len = p.getTotalLength();
          const pt = p.getPointAtLength(len * labelAt);
          t.setAttribute("x", pt.x + 6);
          t.setAttribute("y", pt.y - 8);
          t.textContent = label;
          svg.appendChild(t);
        }
      }

      function render() {
        const w = diagram.clientWidth;
        const h = diagram.clientHeight;
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        svg.setAttribute("width", w);
        svg.setAttribute("height", h);

        clearWiresKeepDefs();

        const R_user = rect("user");
        const R_config = rect("config");
        const R_matjson = rect("matjson");
        const R_matdb = rect("matdb");
        const R_optional = rect("optional");
        const R_cli = rect("cli");
        const R_loop = rect("loop");
        const R_plot = rect("plot");
        const R_outtxt = rect("outtxt");
        const R_outcsv = rect("outcsv");
        const R_view = rect("view");

        // Trunks (keeps joins clean + readable)
        const trunkX_in = Math.round((R_config.right + R_cli.left) / 2);
        const trunkX_out = Math.round((R_loop.right + R_outtxt.left) / 2);

        // 1) User -> config (straight, with arrow)
        {
          const s = port(R_user, "right");
          const e = port(R_config, "left");
          addWire([{ x: s.x, y: s.y }, { x: e.x, y: e.y }], { arrowEnd: true });
        }

        // 2) JSON -> MaterialDB (straight, with arrow)
        {
          const s = port(R_matjson, "right");
          const e = port(R_matdb, "left");
          addWire([{ x: s.x, y: s.y }, { x: e.x, y: e.y }], { arrowEnd: true });
        }

        // 3) Merge inputs: config + matdb -> trunk (NO arrows), then ONE arrow trunk -> CLI
        const joinY = Math.round((R_config.cy + R_matdb.cy) / 2);

        // config -> trunk
        {
          const s = port(R_config, "right");
          addWire(
            [
              { x: s.x, y: s.y },
              { x: trunkX_in, y: s.y },
              { x: trunkX_in, y: joinY }
            ],
            { arrowEnd: false, label: "inputs", labelAt: 0.42 }
          );
        }

        // matdb -> trunk
        {
          const s = port(R_matdb, "right");
          addWire(
            [
              { x: s.x, y: s.y },
              { x: trunkX_in, y: s.y },
              { x: trunkX_in, y: joinY }
            ],
            { arrowEnd: false }
          );
        }

        // trunk -> CLI (single arrow into CLI)
        {
          const e = port(R_cli, "left");
          addWire([{ x: trunkX_in, y: joinY }, { x: e.x, y: joinY }], { arrowEnd: true });
        }

        // 4) Optional sweep -> loop (dashed because optional, roomy)
        {
          const s = port(R_optional, "right");
          const e = port(R_loop, "left");
          addWire(
            [
              { x: s.x, y: s.y },
              { x: trunkX_in, y: s.y },
              { x: trunkX_in, y: e.y },
              { x: e.x, y: e.y }
            ],
            { arrowEnd: true, label: "sweep", labelAt: 0.55, dashed: true }
          );
        }

        // 5) CLI -> Loop (clear down arrow, no floating triangle)
        {
          const s = port(R_cli, "bottom");
          const e = port(R_loop, "top");
          // Go straight down, then across to center of loop top
          addWire(
            [
              { x: s.x, y: s.y },
              { x: s.x, y: e.y },
              { x: e.x, y: e.y }
            ],
            { arrowEnd: true }
          );
        }

        // 6) Loop -> outputs (two taps, labels)
        // Attach points inside the loop's right edge (keeps consistent)
        const bestY = Math.round(R_loop.top + 110);
        const logY  = Math.round(R_loop.top + 220);

        // best -> outtxt
        {
          const e = port(R_outtxt, "left");
          addWire(
            [
              { x: R_loop.right, y: bestY },
              { x: trunkX_out, y: bestY },
              { x: trunkX_out, y: e.y },
              { x: e.x, y: e.y }
            ],
            { arrowEnd: true, label: "best", labelAt: 0.55 }
          );
        }

        // log -> outcsv
        {
          const e = port(R_outcsv, "left");
          addWire(
            [
              { x: R_loop.right, y: logY },
              { x: trunkX_out, y: logY },
              { x: trunkX_out, y: e.y },
              { x: e.x, y: e.y }
            ],
            { arrowEnd: true, label: "log", labelAt: 0.55 }
          );
        }

        // 7) Outputs -> Plotting (merge bus UNDER outputs, then single arrow into plotting)
        // A clean merge point centered under plot
        const busY = Math.round(R_plot.bottom + 26);
        const busX = Math.round(R_plot.cx);

        // outtxt up to bus (no arrow)
        {
          const s = port(R_outtxt, "top");
          addWire(
            [
              { x: s.x, y: s.y },
              { x: s.x, y: busY },
              { x: busX, y: busY }
            ],
            { arrowEnd: false }
          );
        }

        // outcsv up to bus (no arrow)
        {
          const s = port(R_outcsv, "top");
          addWire(
            [
              { x: s.x, y: s.y },
              { x: s.x, y: busY },
              { x: busX, y: busY }
            ],
            { arrowEnd: false }
          );
        }

        // bus -> plot (single arrow)
        {
          const e = port(R_plot, "bottom");
          addWire(
            [
              { x: busX, y: busY },
              { x: busX, y: e.y },
              { x: e.x, y: e.y }
            ],
            { arrowEnd: true }
          );
        }

        // 8) Plot -> View (correct direction)
        {
          const s = port(R_plot, "right");
          const e = port(R_view, "left");
          addWire([{ x: s.x, y: s.y }, { x: e.x, y: e.y }], { arrowEnd: true });
        }
      }

      window.addEventListener("load", render);
      window.addEventListener("resize", render);
    </script>
  </body>
</html>
